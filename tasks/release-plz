#!/usr/bin/env bash
# shellcheck shell=bash
set -euxo pipefail

released_versions="$(git tag --list | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$')"
cur_version="$(cargo pkgid usage-lib | cut -d# -f2 | cut -d@ -f2)"
if ! echo "$released_versions" | grep -q "^v$cur_version$"; then
  echo "Releasing $cur_version"
  if [ "${usage_dry_run:-}" != 1 ]; then
    cargo publish -p usage-lib
    cargo publish -p usage-cli
    git tag "v$cur_version"
    git push --tags
  fi
  exit 0
fi

version="$(git cliff --bumped-version)"
prev_tag="$(git describe --tags --abbrev=0 2>/dev/null || echo "")"

if [ "${usage_dry_run:-}" == 1 ]; then
  echo "version: $version"
  changelog="$(git cliff --bump --unreleased --strip all)"
  echo "changelog: $changelog"
  exit 0
fi

# Generate editorialized release notes using LLM
echo "Generating editorialized release notes..."
EDITORIALIZED_NOTES="$(./scripts/gen-release-summary.sh "$version" "$prev_tag")"

# Validate we got non-empty release notes
if [[ -z $EDITORIALIZED_NOTES ]]; then
  echo "Error: Failed to generate release notes (empty output)" >&2
  exit 1
fi

# Create the release header with appropriate URL format
RELEASE_DATE="$(date +%Y-%m-%d)"
if [[ -n $prev_tag ]]; then
  RELEASE_HEADER="## [$version](https://github.com/jdx/usage/compare/$prev_tag..$version) - $RELEASE_DATE"
else
  # No previous tag - link to the tag directly instead of a compare URL
  RELEASE_HEADER="## [$version](https://github.com/jdx/usage/releases/tag/$version) - $RELEASE_DATE"
fi

# Insert the new release before the first existing release section (## [)
# This handles any CHANGELOG format as long as releases start with ## [
# Use ENVIRON for notes to avoid awk interpreting backslash escape sequences
export RELEASE_HEADER EDITORIALIZED_NOTES
awk_exit_code=0
awk '
	/^## \[/ && !inserted {
		# Insert new release before the first existing release
		print ENVIRON["RELEASE_HEADER"]
		print ""
		print ENVIRON["EDITORIALIZED_NOTES"]
		print ""
		inserted = 1
	}
	{ print }
	END {
		# Signal whether insertion happened via exit code
		exit (inserted ? 0 : 1)
	}
' CHANGELOG.md >CHANGELOG.md.tmp || awk_exit_code=$?

if [[ $awk_exit_code -ne 0 ]]; then
  echo "Error: Failed to insert release notes into CHANGELOG.md (no existing release section found)" >&2
  rm -f CHANGELOG.md.tmp
  exit 1
fi
mv CHANGELOG.md.tmp CHANGELOG.md
echo "Editorialized release notes added to CHANGELOG.md"

cargo set-version "${version#v}" --exclude clap_usage
mise run render
mise run lint-fix

git config user.name mise-en-dev
git config user.email 123107610+mise-en-dev@users.noreply.github.com
cargo update
pnpm update
git add \
  {./,cli/,lib/}Cargo.* \
  package.json pnpm-lock.yaml \
  cli/usage.usage.kdl \
  docs/cli/reference/* \
  CHANGELOG.md
git checkout -B release
git commit -m "chore: release $version"
git push origin release --force

if [[ "$(gh pr list --label release)" == "" ]]; then
  gh pr create --title "chore: release $version" --body "$EDITORIALIZED_NOTES" --label "release" --head release
else
  gh pr edit --title "chore: release $version" --body "$EDITORIALIZED_NOTES"
fi
